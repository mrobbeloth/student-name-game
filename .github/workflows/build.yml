name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: read

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact-name: linux
            installer-ext: deb
          - os: windows-latest
            artifact-name: windows
            installer-ext: msi
          - os: macos-latest
            artifact-name: macos
            installer-ext: dmg

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Extract version from pom.xml
      id: version
      run: |
        VERSION=$(sed -n 's/.*<version>\(.*\)<\/version>.*/\1/p' pom.xml | head -1)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
      shell: bash
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Make Maven wrapper executable
      if: matrix.os != 'windows-latest'
      run: chmod +x ./mvnw
      shell: bash
        
    - name: Install WiX Toolset (Windows only)
      if: matrix.os == 'windows-latest'
      run: |
        choco install wixtoolset -y
        echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH
      shell: pwsh
      
    - name: Build with Maven (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: ./mvnw clean package -DskipTests -DskipNativePackage
      shell: bash
      
    - name: Build with Maven (Windows)
      if: matrix.os == 'windows-latest'
      run: .\mvnw.cmd clean package -DskipTests -DskipNativePackage
      shell: pwsh
      
    - name: Run tests (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: ./mvnw test
      shell: bash
      
    - name: Run tests (Windows)
      if: matrix.os == 'windows-latest'
      run: .\mvnw.cmd test
      shell: pwsh
      
    - name: Create custom JRE with jlink (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        jlink \
          --module-path $JAVA_HOME/jmods \
          --add-modules java.base,java.desktop,java.logging,java.naming,java.sql,java.xml,java.scripting,java.prefs,jdk.unsupported,jdk.crypto.ec \
          --output runtime \
          --strip-debug \
          --compress=2 \
          --no-header-files \
          --no-man-pages
      shell: bash
      
    - name: Create custom JRE with jlink (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        jlink `
          --module-path "$env:JAVA_HOME\jmods" `
          --add-modules java.base,java.desktop,java.logging,java.naming,java.sql,java.xml,java.scripting,java.prefs,jdk.unsupported,jdk.crypto.ec `
          --output runtime `
          --strip-debug `
          --compress=2 `
          --no-header-files `
          --no-man-pages
      shell: pwsh
      
    - name: Create portable distribution (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        mkdir -p dist/student-name-game
        cp target/student-name-game-${{ steps.version.outputs.version }}.jar dist/student-name-game/student-name-game.jar
        cp src/main/scripts/run.bat dist/student-name-game/ 2>/dev/null || true
        cp src/main/scripts/run.sh dist/student-name-game/ 2>/dev/null || true
        chmod +x dist/student-name-game/run.sh 2>/dev/null || true
        cp src/main/dist/portable.txt dist/student-name-game/ 2>/dev/null || true
        cp src/main/dist/README.txt dist/student-name-game/ 2>/dev/null || true
        cp -r runtime dist/student-name-game/
      shell: bash
      
    - name: Create portable distribution (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        New-Item -ItemType Directory -Path "dist/student-name-game" -Force
        Copy-Item "target/student-name-game-${{ steps.version.outputs.version }}.jar" "dist/student-name-game/student-name-game.jar"
        Copy-Item "src/main/scripts/run.bat" "dist/student-name-game/" -ErrorAction SilentlyContinue
        Copy-Item "src/main/scripts/run.sh" "dist/student-name-game/" -ErrorAction SilentlyContinue
        Copy-Item "src/main/dist/portable.txt" "dist/student-name-game/" -ErrorAction SilentlyContinue
        Copy-Item "src/main/dist/README.txt" "dist/student-name-game/" -ErrorAction SilentlyContinue
        Copy-Item "runtime" "dist/student-name-game/" -Recurse -Force
      shell: pwsh
      
    - name: Create portable ZIP (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd dist
        zip -r student-name-game-${{ matrix.artifact-name }}-portable.zip student-name-game/
      shell: bash
      
    - name: Create portable ZIP (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path dist/student-name-game -DestinationPath dist/student-name-game-${{ matrix.artifact-name }}-portable.zip
      shell: pwsh
      
    - name: Create native installer (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        jpackage \
          --type deb \
          --input target \
          --main-jar student-name-game-${{ steps.version.outputs.version }}.jar \
          --main-class com.example.namegame.NameGameApplication \
          --name "student-name-game" \
          --app-version ${{ steps.version.outputs.version }} \
          --vendor "Student Name Game" \
          --linux-shortcut \
          --dest target/installer
      shell: bash
      continue-on-error: true
      
    - name: Create native installer (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        jpackage `
          --type msi `
          --input target `
          --main-jar student-name-game-${{ steps.version.outputs.version }}.jar `
          --main-class com.example.namegame.NameGameApplication `
          --name "Student Name Game" `
          --app-version "${{ steps.version.outputs.version }}" `
          --vendor "Student Name Game" `
          --win-menu `
          --win-shortcut `
          --dest target/installer
      shell: pwsh
      continue-on-error: true
      
    - name: Create native installer (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        jpackage \
          --type dmg \
          --input target \
          --main-jar student-name-game-${{ steps.version.outputs.version }}.jar \
          --main-class com.example.namegame.NameGameApplication \
          --name "Student Name Game" \
          --app-version ${{ steps.version.outputs.version }} \
          --vendor "Student Name Game" \
          --mac-package-name "StudentNameGame" \
          --dest target/installer
      shell: bash
      continue-on-error: true
      
    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: portable-${{ matrix.artifact-name }}
        path: dist/student-name-game-${{ matrix.artifact-name }}-portable.zip
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: installer-${{ matrix.artifact-name }}
        path: target/installer/*.${{ matrix.installer-ext }}
        if-no-files-found: ignore

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: true
        generate_release_notes: true
        files: |
          artifacts/portable-*/*.zip
          artifacts/installer-*/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
