name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact-name: linux
            installer-ext: deb
          - os: windows-latest
            artifact-name: windows
            installer-ext: msi
          - os: macos-latest
            artifact-name: macos
            installer-ext: dmg

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Install WiX Toolset (Windows only)
      if: matrix.os == 'windows-latest'
      run: |
        choco install wixtoolset -y
        echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH
      shell: pwsh
      
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Run tests
      run: mvn test
      
    - name: Create custom JRE with jlink
      run: |
        jlink \
          --module-path $JAVA_HOME/jmods \
          --add-modules java.base,java.desktop,java.logging,java.naming,java.sql,java.xml,jdk.unsupported \
          --output runtime \
          --strip-debug \
          --compress=2 \
          --no-header-files \
          --no-man-pages
      shell: bash
      
    - name: Create portable distribution
      run: |
        mkdir -p dist/student-name-game
        cp target/student-name-game-*-shaded.jar dist/student-name-game/student-name-game.jar
        cp src/main/scripts/run.bat dist/student-name-game/ || true
        cp src/main/scripts/run.sh dist/student-name-game/ || true
        chmod +x dist/student-name-game/run.sh || true
        cp src/main/dist/portable.txt dist/student-name-game/
        cp src/main/dist/README.txt dist/student-name-game/
        cp -r runtime dist/student-name-game/
      shell: bash
      
    - name: Create portable ZIP
      run: |
        cd dist
        zip -r student-name-game-${{ matrix.artifact-name }}-portable.zip student-name-game/
      shell: bash
      
    - name: Create native installer (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        jpackage \
          --type deb \
          --input target \
          --main-jar student-name-game-*-shaded.jar \
          --main-class com.example.namegame.Launcher \
          --name "student-name-game" \
          --app-version ${GITHUB_REF_NAME#v} \
          --vendor "Student Name Game" \
          --linux-shortcut \
          --dest target/installer
      shell: bash
      continue-on-error: true
      
    - name: Create native installer (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        jpackage `
          --type msi `
          --input target `
          --main-jar (Get-ChildItem target/student-name-game-*-shaded.jar).Name `
          --main-class com.example.namegame.Launcher `
          --name "Student Name Game" `
          --app-version "$($env:GITHUB_REF_NAME -replace 'v','')" `
          --vendor "Student Name Game" `
          --win-menu `
          --win-shortcut `
          --dest target/installer
      shell: pwsh
      continue-on-error: true
      
    - name: Create native installer (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        jpackage \
          --type dmg \
          --input target \
          --main-jar student-name-game-*-shaded.jar \
          --main-class com.example.namegame.Launcher \
          --name "Student Name Game" \
          --app-version ${GITHUB_REF_NAME#v} \
          --vendor "Student Name Game" \
          --mac-package-name "StudentNameGame" \
          --dest target/installer
      shell: bash
      continue-on-error: true
      
    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: portable-${{ matrix.artifact-name }}
        path: dist/student-name-game-${{ matrix.artifact-name }}-portable.zip
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: installer-${{ matrix.artifact-name }}
        path: target/installer/*.${{ matrix.installer-ext }}
        if-no-files-found: ignore

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: true
        generate_release_notes: true
        files: |
          artifacts/portable-*/*.zip
          artifacts/installer-*/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
